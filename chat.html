<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>채팅 + 실시간 위치</title>
  <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#FFF8F2; --text:#59463E; --muted:#806A5A;
      --primary:#F6A96D; --primary-600:#e98c45;
      --brand:#FFE8C2; --brand-200:#FADFCB;
      --card:#FFFFFF; --card-br:#FFE1CB;
      --shadow-soft: 0 4px 10px rgba(0,0,0,0.06);
      --radius:20px;
      --header-h:72px; --footer-h:90px;
      --resizer-w:10px;
      --desktop-chat-w:420px;           /* 초기 채팅 폭 */
      --desktop-chat-w-min:320px;       /* 최소 */
      --desktop-chat-w-max:640px;       /* 최대 */
      --sheet-snap-min:20vh;            /* 모바일 바텀시트 스냅 1 */
      --sheet-snap-mid:70vh;            /* 스냅 2 */
      --sheet-snap-max:95vh;            /* 스냅 3 */
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --input-h: 64px;                  /* 채팅 입력바 높이 */
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0; font-family:'SUIT',sans-serif;
      background:var(--bg); color:var(--text);
      overflow:hidden; display:flex; flex-direction:column;
    }
    a{ color:inherit; text-decoration:none }

    /* 공통 메인 높이 */
    .main{
      height: calc(100dvh - var(--header-h) - var(--footer-h));
      margin-top: var(--header-h);
      position:relative;
    }

    /* ============ 데스크톱 레이아웃 (좌 채팅 / 우 지도) ============ */
    .desktop-split{
      height:100%; max-width:1400px; margin:0 auto;
      display:none; /* 모바일 기본 비활성 */
      grid-template-columns: var(--desktop-chat-w) var(--resizer-w) 1fr;
    }
    .desktop-split .panel{
      border:2px solid var(--card-br); background:var(--card);
      display:flex; flex-direction:column;
    }
    .desktop-split .panel header{
      padding:10px 12px; border-bottom:1px solid var(--brand-200);
      background:#FFF4E9; font-weight:800;
    }
    .desktop-split .panel .body{
      flex:1 1 auto; display:flex; flex-direction:column;
      overflow:hidden; padding:0;
    }

    .resizer{
      width:var(--resizer-w); cursor:col-resize; background:linear-gradient(#FFD9AF,#FFE8C2);
    }

    /* 채팅(데스크톱) */
    #chatBoxDesk{
      flex:1 1 auto; overflow:auto;
      padding: 12px 12px calc(var(--input-h) + 12px);
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{ max-width:78%; padding:12px 14px; border-radius:18px; font-size:16px; line-height:1.5; word-break:break-word; }
    .me{ align-self:flex-end; background:#FFE2D1; }
    .other{ align-self:flex-start; background:#FFD9AF; }

    #chatPanelDesk .chat-input{
      position: sticky; bottom: 0; left:0; right:0;
      height: var(--input-h);
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      background:var(--card);
      border-top:1px dashed var(--brand-200);
      box-shadow:0 -6px 12px rgba(0,0,0,0.06);
      z-index:1;
    }
    #chatPanelDesk .chat-input input{ flex:1; height:42px; padding:0 12px; font-size:16px; border:1px solid #ccc; border-radius:12px; outline:none; }
    #chatPanelDesk .chat-input button{ height:42px; padding:0 16px; font-size:16px; background:#FFB88A; color:#fff; border:none; border-radius:12px; cursor:pointer; white-space:nowrap; }

    /* 지도 캔버스 (데스크톱) */
    #mapCanvasDesktop{ height:100%; width:100%; position:relative; }
    #mapCanvasDesktop .map-bg{
      position:absolute; inset:0;
      background:
        linear-gradient(0deg, rgba(255,255,255,.25), rgba(255,255,255,.25)),
        url('https://tile.openstreetmap.org/5/28/12.png');
      background-size:cover;
      transition: transform .12s ease-out;
    }
    .zoom-controls{
      position:absolute; right:12px; top:12px; display:flex; flex-direction:column; gap:6px; z-index:2;
    }
    .zoom-controls button{
      width:38px; height:38px; border:none; border-radius:10px; background:#fff; box-shadow:var(--shadow-soft); cursor:pointer; font-weight:900;
    }

    /* ============ 모바일 레이아웃 (지도 + 바텀시트) ============ */
    .mobile-map{
      position:absolute; inset:0; display:block;
      z-index:0; /* 지도는 아래로 */
    }
    .mobile-map .map-bg{
      position:absolute; inset:0;
      background:
        linear-gradient(0deg, rgba(255,255,255,.25), rgba(255,255,255,.25)),
        url('https://tile.openstreetmap.org/5/28/12.png');
      background-size:cover;
      transition: transform .12s ease-out;
    }

    /* 바텀시트 */
    .sheet{
      position:absolute; left:0; right:0;
      bottom:0; height:var(--sheet-snap-mid);
      max-height: calc(100dvh - 8px); /* 여유 증가 */
      background:#fff; border-radius:16px 16px 0 0;
      box-shadow:0 -8px 24px rgba(0,0,0,.12);
      transform: translateY(0);
      display:flex; flex-direction:column;
      transition: height .18s ease, transform .18s ease;
      will-change: transform, height;
      z-index:3;
    }
    .sheet .handle{
      height:24px; display:flex; align-items:center; justify-content:center; cursor:grab; user-select:none;
    }
    .sheet .handle::before{
      content:""; width:48px; height:5px; border-radius:999px; background:#d9d9d9;
    }
    .sheet header{
      padding:0 14px 8px; font-weight:800; border-bottom:1px solid #f2e6db;
    }

    /* ✅ 바텀시트: 스크롤 영역(메시지)과 입력바 분리 */
    .sheet .content{
      flex:1 1 auto; min-height:0;
      overflow:auto;
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }

    /* ✅ 바텀시트 하단 입력바 (content 밖) */
    .sheet-footer{
      position: sticky; bottom: 0; left: 0; right: 0;
      height: var(--input-h);
      display:flex; gap:8px; align-items:center;
      padding:10px 12px calc(10px + var(--safe-bottom));
      background:#fff;
      border-top:1px solid #f2e6db;
      box-shadow:0 -6px 12px rgba(0,0,0,0.06);
      z-index:3;
    }
    .sheet-footer input{ flex:1; height:42px; padding:0 12px; font-size:16px; border:1px solid #ccc; border-radius:12px; outline:none; }
    .sheet-footer button{ height:42px; padding:0 16px; font-size:16px; background:#FFB88A; color:#fff; border:none; border-radius:12px; cursor:pointer; white-space:nowrap; }

    /* ✅ 공통: 채팅 리스트 컨테이너 */
    .chat-box{
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* (선택) 모바일에서 리스트 여백 살짝 보강 */
    #chatBoxMob{
      padding-bottom: 10px;
    }

    .chat-page .site-footer{
      margin-top: 0 !important;
    }
    
    /* 푸터는 가장 위 레이어로 */
    #footer-root { position: relative; z-index: 10; }

    /* 반응 전환 */
    @media (min-width:1024px){
      .desktop-split{ display:grid; }
      .mobile-map{ display:none; }  /* 데스크톱에선 모바일 뷰 숨김 */
    }
    @media (max-width:600px){
      .msg{ font-size:15px; }
    }
  </style>

  <!-- 공통 헤더/푸터 CSS -->
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/footer.css">
</head>
<body class="chat-page">
  <!-- 드로어 -->
  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-hidden="true" aria-label="모바일 내비게이션">
    <header>
      <b>메뉴</b>
      <button id="drawerClose" aria-label="메뉴 닫기">✕</button>
    </header>
    <nav>
      <a href="about.html">서비스 소개</a>
      <a href="guide.html">이용방법</a>
      <a href="login.html">로그인</a>
      <a href="notice.html">공지</a>
      <a href="mypage.html">내정보</a>
      <a href="points.html">포인트</a>
      <a href="help.html">도움 요청하기</a>
      <a href="give.html">도움 주기</a>
      <a href="#">로그아웃</a>
    </nav>
  </aside>

  <!-- 고정 헤더 -->
  <header>
    <div class="container">
      <div class="header-container">
        <div class="header-left">
          <button class="hamburger" id="hamburger" aria-label="메뉴 열기">☰</button>
          <nav class="topnav" id="topnav" aria-label="상단 내비게이션">
            <a href="about.html">서비스 소개</a>
            <a href="guide.html">이용방법</a>
            <a href="notice.html">공지</a>
          </nav>
        </div>
        <div class="logo"><a href="index.html">EuM:</a></div>
        <div class="header-right" id="rightArea"><!-- header.js가 채움 --></div>
      </div>
    </div>
  </header>

  <!-- 메인 -->
  <main class="main">
    <!-- 데스크톱: 좌우 분할 (우측 지도 비중 더 큼) -->
    <section class="desktop-split" id="desktopSplit">
      <!-- 채팅 패널 -->
      <article class="panel" id="chatPanelDesk" aria-label="채팅창">
        <header>💬 짝꿍 이음이와 대화</header>
        <div class="body">
          <div id="chatBoxDesk">
            <div class="msg other">안녕하세요! 무엇을 도와드릴까요?</div>
            <div class="msg me">약국 가는 길을 알려주실 수 있나요?</div>
          </div>
          <div class="chat-input">
            <input type="text" id="msgInputDesk" placeholder="메시지를 입력하세요..." />
            <button id="sendBtnDesk">전송</button>
          </div>
        </div>
      </article>
      <!-- 리사이저 -->
      <div class="resizer" id="resizer" aria-hidden="true" title="폭 조절"></div>
      <!-- 지도 -->
      <article class="panel" id="mapPanelDesk" aria-label="지도">
        <header>🗺️ 실시간 위치 공유</header>
        <div class="body" style="padding:0;">
          <div id="mapCanvasDesktop">
            <div class="map-bg" id="mapBgDesk"></div>
            <div class="zoom-controls">
              <button id="zoomInDesk">+</button>
              <button id="zoomOutDesk">−</button>
              <button id="recenterDesk">◎</button>
            </div>
          </div>
        </div>
      </article>
    </section>

    <!-- 모바일: 전면 지도 + 바텀시트(채팅) -->
    <section class="mobile-map" id="mobileMap">
      <div class="map-bg" id="mapBgMobile"></div>
      <div class="zoom-controls">
        <button id="zoomInMob">+</button>
        <button id="zoomOutMob">−</button>
        <button id="recenterMob">◎</button>
      </div>

      <div class="sheet" id="chatSheet" aria-label="채팅 시트" aria-expanded="false">
        <div class="handle" id="sheetHandle" aria-label="드래그하여 시트 높이 조절"></div>
        <header>💬 짝꿍 이음이와 대화</header>

        <!-- 메시지 스크롤 영역 -->
        <div class="content" id="chatContentMob">
          <div class="chat-box" id="chatBoxMob">
            <div class="msg other">안녕하세요! 무엇을 도와드릴까요?</div>
            <div class="msg me">약국 가는 길을 알려주실 수 있나요?</div>
          </div>
        </div>

        <!-- ✅ 입력창: content 밖, 시트 하단 고정 -->
        <div class="sheet-footer">
          <input type="text" id="msgInputMob" placeholder="메시지를 입력하세요..." />
          <button id="sendBtnMob">전송</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 푸터(하단 네비 대용) -->
  <div id="footer-root"></div>

  <!-- 공통 스크립트 -->
  <script src="js/header.js"></script>
  <script src="js/footer.js"></script>

  <script>
    /* ===== 푸터 높이 반영 ===== */
    function fitFooter(){
      const f = document.querySelector('#footer-root .site-footer');
      if(f){ document.documentElement.style.setProperty('--footer-h', f.offsetHeight + 'px'); }
    }
    function mountFooterAndFit(){
      renderFooter({ mount:'#footer-root', siteName:'EuM:', tagline:'따뜻한 연결, 함께 만드는 우리 동네' });
      requestAnimationFrame(fitFooter);
    }
    mountFooterAndFit();
    window.addEventListener('resize', fitFooter);

    /* ===== 채팅 전송 (데스크톱/모바일 공통 유틸) ===== */
    function bindChat(sendBtnId, inputId, boxId){
      const btn = document.getElementById(sendBtnId);
      const input = document.getElementById(inputId);
      const box = document.getElementById(boxId);
      function send(){
        const txt = input.value.trim();
        if(!txt) return;
        const el = document.createElement('div');
        el.className = 'msg me';
        el.textContent = txt;
        box.appendChild(el);
        input.value = '';
        box.scrollTop = box.scrollHeight; // 최신 메시지로
      }
      btn.addEventListener('click', send);
      input.addEventListener('keydown', e=>{ if(e.key==='Enter') send(); });
    }
    bindChat('sendBtnDesk','msgInputDesk','chatBoxDesk');
    bindChat('sendBtnMob','msgInputMob','chatBoxMob');

    /* ===== 데스크톱: 리사이저 (채팅폭 가변) ===== */
    (function(){
      const split = document.getElementById('desktopSplit');
      const rz = document.getElementById('resizer');
      if(!split || !rz) return;
      let dragging=false, startX=0, startW=0;

      function px(n){ return `${n}px`; }
      function getLeftWidth(){
        const cols = getComputedStyle(split).gridTemplateColumns.split(' ');
        return parseFloat(cols[0]);
      }
      function setLeftWidth(n){
        const min = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--desktop-chat-w-min')) || 320;
        const max = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--desktop-chat-w-max')) || 640;
        const clamped = Math.max(min, Math.min(max, n));
        split.style.gridTemplateColumns = `${px(clamped)} var(--resizer-w) 1fr`;
        // 지도 SDK가 있다면 여기서 resize 트리거
      }

      rz.addEventListener('mousedown', (e)=>{
        dragging=true; startX=e.clientX; startW=getLeftWidth();
        document.body.style.userSelect='none';
      });
      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        setLeftWidth(startW + (e.clientX - startX));
      });
      window.addEventListener('mouseup', ()=>{
        dragging=false; document.body.style.userSelect='';
      });
    })();

    /* ===== 모바일: 바텀시트 드래그 스냅 (실측 기반) ===== */
    (function(){
      const sheet = document.getElementById('chatSheet');
      const handle = document.getElementById('sheetHandle');
      if(!sheet || !handle) return;

      const vh = () => Math.max(window.innerHeight, document.documentElement.clientHeight);
      const mainEl = document.querySelector('.main');

      function cssVhVar(name, fallbackVh){
        const raw = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        const num = parseFloat(raw);
        return isNaN(num) ? fallbackVh * vh() : (raw.endsWith('vh') ? (num/100)*vh() : num);
      }

      function getSnaps(){
        const mainH = mainEl ? mainEl.clientHeight : vh();
        const maxCap = Math.min(mainH - 8, 0.98 * vh());
        const minPx  = Math.max(80, cssVhVar('--sheet-snap-min', 0.20));
        const midPx  = Math.min(cssVhVar('--sheet-snap-mid', 0.70), maxCap);
        const maxPx  = Math.min(cssVhVar('--sheet-snap-max', 0.95), maxCap);
        return { minPx, midPx, maxPx };
      }

      function setH(px){ sheet.style.height = Math.round(px) + 'px'; }

      function snap(to){
        const {minPx, midPx, maxPx} = getSnaps();
        const target = (to==='min')? minPx : (to==='max')? maxPx : midPx;
        sheet.style.transition = 'height .18s ease, transform .18s ease';
        setH(target);
        sheet.setAttribute('aria-expanded', to==='max' ? 'true':'false');
        // 지도 SDK 쓰면 여기서 resize 트리거
      }

      let startY=0, startH=0, dragging=false;

      function onStart(y){
        dragging=true; startY=y; startH=sheet.getBoundingClientRect().height;
        sheet.style.transition='none';
      }
      function onMove(y){
        if(!dragging) return;
        const dy = startY - y; // 위로 올리면 +
        const {minPx, maxPx} = getSnaps();
        const next = Math.max(minPx, Math.min(maxPx, startH + dy));
        setH(next);
      }
      function onEnd(){
        if(!dragging) return;
        dragging=false; sheet.style.transition='';
        const cur = sheet.getBoundingClientRect().height;
        const {minPx, midPx, maxPx} = getSnaps();
        const upThreshold   = (midPx + maxPx) * 0.55;
        const downThreshold = (minPx + midPx) * 0.45;
        if(cur >= upThreshold) snap('max');
        else if(cur <= downThreshold) snap('min');
        else snap('mid');
      }

      // 터치 + 마우스 드래그
      handle.addEventListener('touchstart', e=>onStart(e.touches[0].clientY), {passive:true});
      handle.addEventListener('touchmove',  e=>onMove(e.touches[0].clientY), {passive:true});
      handle.addEventListener('touchend', onEnd);
      handle.addEventListener('mousedown', e=>onStart(e.clientY));
      window.addEventListener('mousemove', e=>onMove(e.clientY));
      window.addEventListener('mouseup', onEnd);

      // 입력창 포커스 시 자동 최대
      const input = document.getElementById('msgInputMob');
      if(input){
        input.addEventListener('focus', ()=> snap('max'));
        input.addEventListener('blur',  ()=> snap('mid'));
      }

      // 회전/리사이즈 시 스냅 재적용
      window.addEventListener('resize', ()=>{
        const cur = sheet.getBoundingClientRect().height;
        const {minPx, midPx, maxPx} = getSnaps();
        const d = [
          {k:'min', v:Math.abs(cur-minPx)},
          {k:'mid', v:Math.abs(cur-midPx)},
          {k:'max', v:Math.abs(cur-maxPx)}
        ].sort((a,b)=>a.v-b.v)[0].k;
        snap(d);
      });

      // 초기: 중간
      snap('mid');
    })();

    /* ===== 임시 지도 확대/축소 데모 (SDK 붙이면 제거) ===== */
    function bindZoom(bgId, inId, outId, reId){
      const bg = document.getElementById(bgId);
      const zin= document.getElementById(inId);
      const zout= document.getElementById(outId);
      const rec= document.getElementById(reId);
      if(!bg || !zin || !zout || !rec) return;
      let scale=1;
      function apply(){ bg.style.transform = `scale(${scale})`; bg.style.transformOrigin='center'; }
      zin.addEventListener('click', ()=>{ scale=Math.min(2.0, scale+0.1); apply(); });
      zout.addEventListener('click', ()=>{ scale=Math.max(1.0, scale-0.1); apply(); });
      rec.addEventListener('click', ()=>{ scale=1.0; apply(); });
    }
    bindZoom('mapBgDesk','zoomInDesk','zoomOutDesk','recenterDesk');
    bindZoom('mapBgMobile','zoomInMob','zoomOutMob','recenterMob');
  </script>
</body>
</html>