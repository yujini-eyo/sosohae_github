<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.support">

	<!-- ========== 공통 resultMap ========== -->
	<resultMap id="SupportApplicationMap"
		type="com.myspring.eum.support.vo.SupportApplicationVO">
		<id column="application_id" property="applicationId" />
		<result column="article_no" property="articleNo" />
		<result column="volunteer_id" property="volunteerId" />
		<result column="status" property="status" />
		<result column="message" property="message" />
		<result column="created_at" property="createdAt" />
		<result column="updated_at" property="updatedAt" />
		<!-- 조인 컬럼(선택) -->
		<result column="title" property="articleTitle" />
		<result column="owner_id" property="ownerId" />
	</resultMap>

	<!-- ========== 1) 특정 글의 신청자 목록 (applicants.jsp) ========== -->
	<select id="findApplicantsByArticle" parameterType="int"
		resultMap="SupportApplicationMap">
		SELECT
		sa.*,
		ba.title,
		ba.id AS owner_id
		FROM
		support_application sa
		JOIN board_article ba ON ba.articleNO =
		sa.articleNO
		WHERE sa.articleNO = #{value}
		ORDER BY sa.created_at
		DESC
	</select>

	<!-- ========== 2) 내 글들에 달린 전체 신청자 (myApplicants.jsp) ========== -->
	<select id="findApplicantsToOwner" parameterType="string"
		resultMap="SupportApplicationMap">
		SELECT
		sa.*,
		ba.title,
		ba.id AS owner_id
		FROM
		support_application sa
		JOIN board_article ba ON ba.articleNO =
		sa.articleNO
		WHERE ba.id = #{ownerId}
		ORDER BY sa.created_at DESC
	</select>

	<!-- ========== 3) 내가 쓴 글 목록 (myRequests.jsp) ========== -->
	<!-- ArticleVO로 자동 매핑하려면 스네이크→카멜 컬럼은 alias 필요 -->
	<select id="findArticlesByWriter" parameterType="string"
		resultType="com.myspring.eum.board.vo.ArticleVO">
		SELECT
		articleNO AS articleNO,
		parentNO AS parentNO,
		id,
		title,
		content,
		imageFileName AS imageFileName,
		is_notice AS isNotice,
		writeDate AS writeDate,
		svc_type AS svcType,
		region,
		req_at AS reqAt,
		urgency,
		points
		FROM board_article
		WHERE id = #{writerId}
		ORDER BY
		writeDate DESC
	</select>


	<!-- (옵션) 자주 쓰는 쿼리: 내가 지원한 목록 - 이전 오류 보정용 -->
	<select id="findByVolunteerId" parameterType="string"
		resultMap="SupportApplicationMap">
		SELECT
		sa.*,
		ba.title,
		ba.id AS owner_id
		FROM
		support_application sa
		JOIN board_article ba ON ba.articleNO =
		sa.articleNO
		WHERE sa.volunteer_id = #{volunteerId}
		ORDER BY
		sa.created_at DESC
	</select>

	<!-- 지원 신청 INSERT -->
	<insert id="insertApplication" parameterType="map">
		INSERT INTO
		support_application
		(articleNO, volunteer_id, status, message,
		created_at, updated_at)
		VALUES
		(#{articleNo}, #{volunteerId}, 'APPLIED',
		#{message},
		CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
	</insert>

	<!-- 지원 내역 존재 여부 -->
	<select id="existsApplication" parameterType="map"
		resultType="int">
		SELECT COUNT(1)
		FROM support_application
		WHERE articleNO =
		#{articleNo}
		AND volunteer_id = #{volunteerId}
	</select>

</mapper>
