<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.adminBoard">

  <!-- ResultMap: DB는 snake_case, VO는 camelCase -->
  <resultMap id="adminArticleMap" type="adminArticleVO">
    <id     property="articleNO"     column="article_no"/>
    <result property="parentNO"      column="parent_no"/>
    <result property="id"            column="id"/>
    <result property="title"         column="title"/>
    <result property="content"       column="content"/>
    <result property="imageFileName" column="image_file_name"/>
    <result property="isNotice"      column="is_notice"/>
    <result property="writeDate"     column="write_date"/>
  </resultMap>

  <sql id="adminColumns">
    article_no, parent_no, id, title, content, image_file_name, is_notice, write_date
  </sql>

  <!-- 목록 -->
  <select id="adminList" resultMap="adminArticleMap">
    SELECT <include refid="adminColumns"/>
    FROM admin_article
    ORDER BY article_no DESC
  </select>

  <!-- 단건 -->
  <select id="adminselectArticleByNo" parameterType="int" resultMap="adminArticleMap">
    SELECT <include refid="adminColumns"/>
    FROM admin_article
    WHERE article_no = #{value}
  </select>

  <!-- 등록 -->
  <insert id="admininsertNewArticle" parameterType="adminArticleVO"
          useGeneratedKeys="true" keyProperty="articleNO">
    INSERT INTO admin_article
      (parent_no, id, title, content, image_file_name, is_notice)
    VALUES
      (COALESCE(#{parentNO},0), #{id}, #{title}, #{content}, #{imageFileName},
       COALESCE(#{isNotice}, 0))
  </insert>

  <!-- 공지 플래그 업데이트 -->
  <update id="adminupdateNoticeFlag" parameterType="map">
    UPDATE admin_article
    SET is_notice = #{isNotice}
    WHERE article_no = #{articleNO}
  </update>

  <!-- 이미지 제거 -->
  <update id="adminclearImage" parameterType="int">
    UPDATE admin_article
    SET image_file_name = NULL
    WHERE article_no = #{value}
  </update>

  <!-- 삭제 -->
  <delete id="admindeleteArticle" parameterType="int">
    DELETE FROM admin_article WHERE article_no = #{value}
  </delete>

  <!-- ====== [추가] 공지 전용 목록/카운트/최근 N건 ====== -->

  <!-- ✅ 공지 전용 목록 -->
  <select id="adminListNotice" parameterType="map" resultMap="adminArticleMap">
    SELECT
      <include refid="adminColumns"/>
    FROM admin_article
    WHERE is_notice = 1
      <if test="q != null and q != ''">
        AND (title LIKE CONCAT('%', #{q}, '%') OR content LIKE CONCAT('%', #{q}, '%'))
      </if>
    <choose>
      <when test="sort == 'popular'">
        ORDER BY /* 조회수 컬럼이 있다면 교체하세요 */ article_no DESC
      </when>
      <when test="sort == 'oldest'">
        ORDER BY article_no ASC
      </when>
      <otherwise>
        ORDER BY article_no DESC
      </otherwise>
    </choose>
    <if test="offset != null and size != null">
      LIMIT #{size} OFFSET #{offset}
    </if>
  </select>

  <!-- ✅ 공지 총개수 -->
  <select id="adminCountNotice" parameterType="map" resultType="int">
    SELECT COUNT(1)
    FROM admin_article
    WHERE is_notice = 1
      <if test="q != null and q != ''">
        AND (title LIKE CONCAT('%', #{q}, '%') OR content LIKE CONCAT('%', #{q}, '%'))
      </if>
  </select>

</mapper>
